<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Dice 7 Up/Down</title>
<link rel="stylesheet" href="./css/style.css">
</head>
<body>
<div class="wrap">
  <div class="top">
    <div style="display:flex;align-items:center">
      <div class="avatarsRow">
        <img class="av" src="https://i.pravatar.cc/64?img=12" alt="av1"/>
        <img class="av" src="https://i.pravatar.cc/64?img=32" alt="av2"/>
        <img class="av" src="https://i.pravatar.cc/64?img=5" alt="av3"/>
      </div>
      <div class="brand">Dice 7 Up/Down • ZST</div>
    </div>
    <div class="history" id="hist" aria-hidden="true"></div>
    <div class="timer" id="timer">15</div>
  </div>

  <div class="table">
    <!-- CENTER -->
    <div class="center" role="main" aria-label="Game area">
      <div class="multBanner" id="multBanner">Multiplication Active</div>

      <div class="arena" aria-hidden="false">
        <div class="stage">
          <div class="die" id="d1" aria-hidden="true"></div>
          <div class="die two" id="d2" aria-hidden="true"></div>
        </div>
      </div>

      <p class="sumBoard" id="sumBoard">Place bets — roll after timer</p>

      <div class="betPanel" id="panelMain">
        <div class="cell down" data-type="range" data-key="down">
          <div><div style="font-size:16px;font-weight:800">2–6</div><div class="od">1:1</div></div>
          <div class="chip" data-chip>0.00</div>
          <div class="mul" data-mul>×?</div>
        </div>
        <div class="cell mid" data-type="range" data-key="seven">
          <div><div style="font-size:16px;font-weight:800">7</div><div class="od">1:4</div></div>
          <div class="chip" data-chip>0.00</div>
          <div class="mul" data-mul>×?</div>
        </div>
        <div class="cell up" data-type="range" data-key="up">
          <div><div style="font-size:16px;font-weight:800">8–12</div><div class="od">1:1</div></div>
          <div class="chip" data-chip>0.00</div>
          <div class="mul" data-mul>×?</div>
        </div>
      </div>

      <div class="grid" id="grid" aria-hidden="false"></div>
      <div class="meta">Min bet: 0.10 ZST • 1 ZST = 100 BDT ≈ $1.20</div>
    </div>

    <!-- RIGHT -->
    <div class="rightPanel">
      <div class="balRow"><span>Balance</span><strong id="balance">200.00 ZST</strong></div>
      <div class="balRow"><span>Your Bet</span><strong id="yourBet">0.00 ZST</strong></div>

      <!-- ADDED: last result display -->
      <div class="lastRow"><span>Last result</span><strong id="lastResult" class="neutral">0.00 ZST</strong></div>

      <div style="font-weight:700">Chips</div>
      <div class="chips" id="chips">
        <div class="c active" data-amt="0.10">0.10</div>
        <div class="c" data-amt="0.50">0.50</div>
        <div class="c" data-amt="1">1</div>
        <div class="c" data-amt="2">2</div>
        <div class="c" data-amt="5">5</div>
        <div class="c" data-amt="10">10</div>
      </div>

      <div class="ctrls">
        <button id="again">again</button>
        <button id="dbl">x2 double</button>
        <button id="clr">clear</button>
      </div>

      
    </div>
  </div>

  <div class="foot">
    <div class="msg" id="msg">Bet phase…</div>
    <div class="rate">Tx <span id="tx">300000</span></div>
  </div>
</div>
<script>
// Authentication check
const authToken = localStorage.getItem('authToken');
const userData = JSON.parse(localStorage.getItem('userData') || '{}');

if (!authToken) {
    alert('দয়া করে প্রথমে লগইন করুন');
    window.location.href = '../login.html';
    throw new Error('User not authenticated');
}

// ব্যালেন্স userData থেকে লোড করুন
let balance = userData.balance ? parseFloat(userData.balance) : 200.00;

// Logout function for game page
function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userData');
    window.location.href = '../index.html';
}

// Update balance in UI
function refreshUI() {
    // আপনার existing refreshUI function
    $("#balance").textContent = fmt(balance);
    
    // User balance also update করুন যদি UI-তে থাকে
    const userBalanceElement = document.querySelector('.user-balance');
    if (userBalanceElement) {
        userBalanceElement.textContent = fmt(balance);
    }
}

// Game settlement এর পরে balance আপডেট করুন
async function settle(sum) {
    // আপনার existing settle function
    
    // Balance আপডেট করার পর
    if (isLoggedIn()) {
        // Server-এ balance আপডেট করার API call করুন
        await updateServerBalance();
    }
}

// Server-এ balance আপডেট করার function
async function updateServerBalance() {
    try {
        const response = await fetch(`${window.location.origin}/api/update_balance.php`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('authToken')
            },
            body: JSON.stringify({
                balance: balance,
                user_id: getUserData().id
            })
        });
        
        const result = await response.json();
        if (!result.success) {
            console.error('Balance update failed:', result.message);
        }
    } catch (error) {
        console.error('Balance update error:', error);
    }
}
</script><!-- গেম পেজের script.js এর সবচেয়ে উপরে -->
<script>
// Authentication check
const authToken = localStorage.getItem('authToken');
const userData = JSON.parse(localStorage.getItem('userData') || '{}');

if (!authToken) {
    alert('দয়া করে প্রথমে লগইন করুন');
    window.location.href = '../login.html';
    throw new Error('User not authenticated');
}

// ব্যালেন্স userData থেকে লোড করুন
let balance = userData.balance ? parseFloat(userData.balance) : 200.00;

// Logout function for game page
function logout() {
    localStorage.removeItem('authToken');
    localStorage.removeItem('userData');
    window.location.href = '../index.html';
}

// Update balance in UI
function refreshUI() {
    // আপনার existing refreshUI function
    $("#balance").textContent = fmt(balance);
    
    // User balance also update করুন যদি UI-তে থাকে
    const userBalanceElement = document.querySelector('.user-balance');
    if (userBalanceElement) {
        userBalanceElement.textContent = fmt(balance);
    }
}

// Game settlement এর পরে balance আপডেট করুন
async function settle(sum) {
    // আপনার existing settle function
    
    // Balance আপডেট করার পর
    if (isLoggedIn()) {
        // Server-এ balance আপডেট করার API call করুন
        await updateServerBalance();
    }
}

// Server-এ balance আপডেট করার function
async function updateServerBalance() {
    try {
        const response = await fetch(`${window.location.origin}/api/update_balance.php`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('authToken')
            },
            body: JSON.stringify({
                balance: balance,
                user_id: getUserData().id
            })
        });
        
        const result = await response.json();
        if (!result.success) {
            console.error('Balance update failed:', result.message);
        }
    } catch (error) {
        console.error('Balance update error:', error);
    }
}
</script>
<script src="./js/script.js"></script>
</body>
</html>