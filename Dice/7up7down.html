<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
<title>Dice 7 Up/Down</title>
<link rel="stylesheet" href="./css/style.css">
</head>
<body>
<div class="wrap">
  <div class="top">
    <div style="display:flex;align-items:center">
      <div class="avatarsRow">
        <img class="av" src="https://i.pravatar.cc/64?img=12" alt="av1"/>
        <img class="av" src="https://i.pravatar.cc/64?img=32" alt="av2"/>
        <img class="av" src="https://i.pravatar.cc/64?img=5" alt="av3"/>
      </div>
      <div class="brand">Dice 7 Up/Down • ZST</div>
    </div>
    <div class="history" id="hist" aria-hidden="true"></div>
    <div class="timer" id="timer">15</div>
  </div>

  <div class="table">
    <!-- CENTER -->
    <div class="center" role="main" aria-label="Game area">
      <div class="multBanner" id="multBanner">Multiplication Active</div>

      <div class="arena" aria-hidden="false">
        <div class="stage">
          <div class="die" id="d1" aria-hidden="true"></div>
          <div class="die two" id="d2" aria-hidden="true"></div>
        </div>
      </div>

      <p class="sumBoard" id="sumBoard">Place bets — roll after timer</p>

      <div class="betPanel" id="panelMain">
        <div class="cell down" data-type="range" data-key="down">
          <div><div style="font-size:16px;font-weight:800">2–6</div><div class="od">1:1</div></div>
          <div class="chip" data-chip>0.00</div>
          <div class="mul" data-mul>×?</div>
        </div>
        <div class="cell mid" data-type="range" data-key="seven">
          <div><div style="font-size:16px;font-weight:800">7</div><div class="od">1:4</div></div>
          <div class="chip" data-chip>0.00</div>
          <div class="mul" data-mul>×?</div>
        </div>
        <div class="cell up" data-type="range" data-key="up">
          <div><div style="font-size:16px;font-weight:800">8–12</div><div class="od">1:1</div></div>
          <div class="chip" data-chip>0.00</div>
          <div class="mul" data-mul>×?</div>
        </div>
      </div>

      <div class="grid" id="grid" aria-hidden="false"></div>
      <div class="meta">Min bet: 0.10 ZST • 1 ZST = 100 BDT ≈ $1.20</div>
    </div>

    <!-- RIGHT -->
    <div class="rightPanel">
      <div class="balRow"><span>Balance</span><strong id="balance">200.00 ZST</strong></div>
      <div class="balRow"><span>Your Bet</span><strong id="yourBet">0.00 ZST</strong></div>

      <!-- ADDED: last result display -->
      <div class="lastRow"><span>Last result</span><strong id="lastResult" class="neutral">0.00 ZST</strong></div>

      <div style="font-weight:700">Chips</div>
      <div class="chips" id="chips">
        <div class="c active" data-amt="0.10">0.10</div>
        <div class="c" data-amt="0.50">0.50</div>
        <div class="c" data-amt="1">1</div>
        <div class="c" data-amt="2">2</div>
        <div class="c" data-amt="5">5</div>
        <div class="c" data-amt="10">10</div>
      </div>

      <div class="ctrls">
        <button id="again">again</button>
        <button id="dbl">x2 double</button>
        <button id="clr">clear</button>
      </div>

      
    </div>
  </div>

  <div class="foot">
    <div class="msg" id="msg">Bet phase…</div>
    <div class="rate">Tx <span id="tx">300000</span></div>
  </div>
</div>
<script src="../js/auth.js"></script>
<script>
// Authentication check and initialization
authManager.requireAuth();

// Initialize balance from server
let balance = 0;

// Initialize page
document.addEventListener('DOMContentLoaded', async function() {
    console.log('Game initialization started - loading balance from server...');
    
    // Get fresh balance from server - required for gameplay
    const serverBalance = await authManager.getBalance();
    if (serverBalance !== null) {
        balance = parseFloat(serverBalance);
        updateBalanceUI();
        console.log('Balance loaded successfully:', balance);
        
        // Initialize game after balance is loaded
        if (typeof init === 'function') {
            init();
            console.log('Game initialized successfully');
        } else {
            console.error('init function not found - script.js may not be loaded');
        }
        
        // Add runtime check to monitor for deprecated endpoint calls
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = typeof args[0] === 'string' ? args[0] : (args[0] && args[0].url ? args[0].url : '');
            if (String(url).includes('update_balance.php')) {
                console.error('CRITICAL: Deprecated endpoint called!', url);
                alert('Error: Deprecated API endpoint called. This should not happen.');
            }
            return originalFetch.apply(window, args);
        };
    } else {
        // Block gameplay until server balance is available
        document.getElementById('msg').textContent = 'Unable to load balance. Please refresh the page.';
        document.querySelectorAll('.cell, .gcell, #chips .c, #again, #dbl, #clr').forEach(el => {
            el.style.pointerEvents = 'none';
            el.style.opacity = '0.5';
        });
        console.error('Failed to load balance from server. Gameplay disabled.');
    }
});

// Update balance in UI
function updateBalanceUI() {
    const balanceElement = document.getElementById('balance');
    if (balanceElement && typeof fmt === 'function') {
        balanceElement.textContent = fmt(balance);
    }
}

// Game settlement function - apply delta to balance
async function applyGameSettlement(deltaAmount, reason = 'dice_game') {
    try {
        const newBalance = await authManager.applyBalanceDelta(deltaAmount, reason);
        if (newBalance !== null) {
            balance = parseFloat(newBalance);
            updateBalanceUI();
            return parseFloat(newBalance); // Return the actual balance
        } else {
            console.error('Failed to apply game settlement');
            return null; // Return null to indicate failure
        }
    } catch (error) {
        console.error('Game settlement error:', error);
        return null; // Return null to indicate failure
    }
}

// Logout function for game page
function logout() {
    authManager.logout();
}
</script>
<script src="./js/script.js"></script>
</body>
</html>